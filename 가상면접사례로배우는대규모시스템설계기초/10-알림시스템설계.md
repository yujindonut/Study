## 10. 알림 시스템 설계

### 1. 문제 이해 및 설계 범위 확정

- 푸시 알림, SMS 메세지, 이메일
- 실시간 시스템
- 연성 실시간 시스템 
- 천만건의 모바일 푸시알림, 백만 건의 SMS메세지, 5백만 건의 이메일을 보낼 수 있어야한다.

### 2. 개략적 설계안 제시 및 동의 구하기

#### 알림 유형별 지원 방안

- iOS 푸시 알림
  - 알림 제공자 : 알림 요청을 만들어 애플 푸시 알림 서비스로 보내는 주체
    - 단말 토큰 : 알림 요청을 보내는데 필요한 고유 식별자
    - 페이로드 : 알림 내용을 담은 JSON 딕셔너리
  - APNS : 애플이 제공하는 원격 서비스다. 푸시 알림을 iOS 장치로 보내느 역할을 담당한다.
  - iOS 단말 : 푸시 알림을 수신하는 사용자 단말이다.
- 안드로이드 푸시 알림
  - iOS의 APNS대신 FCM을 사용
- SMS 메세지
  - 트윌리오, 넥스모 같은 제3자의 서비스를 많이 이용함
- 이메일
  - 센드그리드, 메일침프
  - 전송 성공률도 높고, 데이터 분석 서비스도 제공한다.

#### 연락처 정보 수집 절차
알림을 보내기 위해 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다.

device 테이블
- id (bigint)
- device_token(varchar)
- user_id (bigint)
- last_logged_in_at (timestamp)

#### 알림 전송 및 수신 절차
- 알림 시스템 (notification system) : 알림 시스템은 알림 전송/수신 처리의 핵심. 
- 제 3자 서비스 : 이 서비스들은 사용자에게 알림을 실제로 전달하는 역할을 한다. 확장성을 고려해야하는데, 
쉽게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어야한다는 뜻이다. 가령 FCM은 중국에서는 사용할 수 없다. 
- iOS, 안드로이드, SMS, 이메일 단말 : 사용자는 자기 단말에서 알림을 수신한다.

##### 문제점
- SPOF: 알림 서비스에 서버가 하나밖에 없어, 그 서버에 장애가 생기면 전체 서비스의 장애로 이루어진다.
- 규모확장성 : 한 대 서비스로 푸시 알림에 관계된 모든것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다.
- 성능 병목: 알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 작업일 수 있다. 트래픽이 많이 몰리는 시간에 시스템이 과부하 상태에 빠질 수 있다.

#### 개략적 설계안 (개선)
- 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리한다.
- 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어질 수 있도록 한다.
- 메세지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다.
- 알림서버는 다음 기능을 제공한다
  - 알림 전송 API : 스팸 방지를 위해 보통 사내 서비스 또는 인증된 클라이언트만 이용가능하다.
  - 알림 검증 : 이메일주소, 전화번호 등에 대한 기본적 검증을 수행한다.
  - 데이터베이스 또는 캐시 질의: 알림에 포함시킬 데이터를 가져오는 기능이다.
  - 알림 전송 : 알림 데이터를 메세지 큐에 넣는다. 본 설계안의 경우 하나 이상의 메세지 큐를 사용하므로 알림을 병렬적으로 처리할 수 있다.
```shell
{
  "to" : [
    {
      "user_id" : 123456
    }
  ],
  "from" : {
    "email" : "from_adress@example.com"
  },
  "subject" :"Hello, World!".
  "content" : [
    {
      "type": "text/plain",
      "value" :"Hello, World!"
    }
  ]
}
```
  - 캐시 : 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시한다.
  - 데이터베이스: 사용자, 알림, 서렂ㅇ 등 다양한 정보를 저장한다.
  - 메시지 큐: 시스템 컴포넌트 간 의존성을 제거하기 위해 사용한다. 다량의 알림이 전송되어야하는 경우를 대비한 버퍼 역할도 한다.
  - 작업 서버: 메시지 큐에서 전송할 알림을 꺼내서 제3자 서비스로 전달하는 역할을 담당하는 서버
  - 제 3자 서비스

### 컴포넌트들이 알림 전송하는 과정

1. API를 호출하여 알림 서버로 알림을 보낸다.
2. 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타데이터를 개시나 데이터베이스에서 가져온다.
3. 알림 서버는 전송할 알림에 맞는 이벤트를 만들어서 해당 이벤트를 위한 큐에 넣는다. 가령 iOS 푸시 알림 이벤트는 iOS 푸시 알림 큐에 넣어야한다.
4. 작업 섯버는 메시지 큐에서 알림 이벤트를 꺼낸다.
5. 작업 서버는 알림을 제3자 서비스로 보낸다.
6. 제3자 서비스는 사용자 단말로 알림을 전송한다.

### 상세설계

#### 안정성
- 데이터 손실방지
  - 알림이 소실되면 안된다.
  - 알림을 데이터베이스에 보관하고 재시도 메커니즘을 구현해야한다.
- 알림 중복 전송 방지
  - 분산시스템에서 알림이 중복되어 전송되기도 할 것이다. 그 빈도를 줄이려면 중복을 탐지하는 메커니즘을 도입하고, 오류를 신중하게 처리해야한다.
  - 보내야할 알림이 도착하면 이벤트id를 검사하여 중복된 이벤트라면 버리고, 그렇지 않으면 알림을 발송한다.

#### 추가로 필요한 컴포넌트 및 고려사항
- 알림템플릿 : 지정된 형식에 맞춰 알람을 만들어내는 틀.
- 알림 설정 : 특정 종류의 알림을 보내기 전에 반드시 해당 사용자가 해당 알림을 켜두었는지 확인해야한다.

#### 전송률 제한
알림을 너무 많이 보내면 사용자가 알림을 끌 수 있음
사용자에게 알림을 보내는 빈도를 제한할 수도 있도록.

#### 재시도 방법
제 3자 서비스가 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣는다. 같은 문제가 계속해서 발생하면 개발자에게 통지한다.

#### 푸시 알림과 보안
iOS와 안드로이드 앱의 경우, 알림 전송 API는 appKey와 appSecret을 사용하여 보안을 유지한다. 인증된, 혹은 승인된 클라이언트를 해당 API를 사요앟여 알림을 보낼 수 있게한다.

#### 큐 모니터링
알림 시스템을 모니터링 할 때 중요한 캐트릭 하나는 큐에 쌓인 알림의 개수이다. 

#### 이벤트 추적
알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭은 사용자를 이해하는데 중요하다. 데이터 분석 서비스는 보통 이벤트 추적 기능도 제공한다. 따라서 보통 
알림 시스템을 만들면 데이터 분석 서비스와도 통합해야만 한다. 

