### 키-값 저장소

비관계형 데이터베이스.

값은 문자열, list, object일 수 있다.

### 문제 이해 및 설계 범위확정

다음 특성을 갖는 키-값 저장을 설계하는 과정

- 높은 가용성을 제공해야함. 시스템은 설사 장애가 있더라도 빨리 응답해야한다.
- 높은 규모 확장성을 제공해야한다. 트래픽 양에 따라 자동적으로 서버 증설/삭제가 이루어져야한다.
- 데이터 일관성 수준은 조정이 가능해야한다.
- 응답 지연시간이 짧아야한다.
- 키-값 쌍의 크기는 10kb이하이다.

### 단일 서버 키-값 저장소

- 키-값 쌍 전부를 메모리에 해시테이블로 저장하는 방법
    - 장점 : 빠른 속도
    - 단점 : 모든 데이터를 메모리 안에 두는 것이 불가능할 수 있다.
- 데이터 압축
- 자주 쓰이는 데이터만 메모리에 두고, 나머지는 디스크에 저장

위의 개선책으로 아래의 방법들을 떠올릴 수 있지만, 한대 서버로만 부족한 때가 오기에 많은 데이터를 저장하기 위해서는 분산 키-값 저장소를 만들 필요가 있다.

## 분산 키-값 저장소

키-값 쌍을 여러 서버에 분산시키는 탓이다. 분산 시스템을 설계할 때는 CAP 정리를 이해해야함

### CAP

`데이터 일관성 ( Consistency)` : 분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했느냐에 관계 없이 **언제나 같은 데이터를 보게** 되어야한다.

`가용성 (availability)` : 분산 시스템에 접속하는 클라이언트는 일부 노드에 장애가 발생하더라도 **항상 응답을 받을** 수 있어야한다.

`파티션 감내(partition tolerance)` : 파티션은 두 노드 사이에 통신 장애가 발생하였음을 의미한다. 파티션 감내는 네트워크 파티션이 생기더라도 **시스템은 계속 동작**하여야한다는 것을 뜻한다.

CP시스템 : 일관성과 파티션 감내를 지원하는 키-값 저장소. 가용성을 희생한다

AP 시스템 : 가용성과 파티션 감내를 지원하는 키-값 저장소. 데이터 일관성을 희생

CA 시스템 : 일관성과 가용성을 지원하는 키-값 저장소. 파티션 감내는 지원하지 않는다. 통상 네트워크 장애는 피할 수 없는 일로 여겨지므로 분산시스템은 반드시 파티션 문제를 감내할 수 있도록 설계 되어야한다. 현실세계에는 존재하지 않는다.

### 실세계의 분산 시스템

분산시스템은 파티션 문제를 피할 수 없다. 파티션 문제가 발생하면 일관성과 가용성 사이에서 하나를 선택해야함.

가용성 < 데이터 일관성 : n1, n2에 대한 쓰기 연산을 중단시켜야하는데 가용성이 깨지게 된다. 예) 온라인 뱅킹 시스템이 계좌 최신 정보를 출력하지 못하면 오류를 반환해야한다.

일관성 < 가용성 : 낡은 데이터를 반환하더라도, 계속 쓰기 연산을 허용해야한다.

### 시스템 컴포넌트

- **데이터 파티션**

  대규모 애플리케이션의 경우 전체 데이터를 한대 서버에 욱여넣는 것은 불가능하다.

  데이터를 파티션 단위로 나눌 때, 고려해야할 2가지.

    - 데이터를 여러 서버에 고르게 분산할 수 있는가?
    - 노드가 추가되거나 삭제될때 데이터의 이동을 최소화할 수 있는가?

  ⇒ 안정 해시를 사용하여 데이터 파티션을 하면 좋다

    - 규모 확장 자동화 : 시스템 부하에 따라 서버가 자동으로 추가되거나 삭제되도록 만들 수 있다.
    - 다양성 : 각 서버의 용량에 맞게 가상 노드의 수를 조정할 수 있다. 고성능 서버는 더 많은 가상 노드를 갖도록 설정할 수 있다.
- 데이터 다중화

  높은 가용성과 안정성을 확보하기 위해서는 데이터를 n개 서버에 비동기적으로 다중화할 필요가 있다.

- 데이터 일관성

  여러 노드에 다중화된 데이터는 적절히 동기화 되어야한다. 정족수 합의 프로토콜을 사용하면 읽기/쓰기 연산 모두에 일관성을 보장할 수 있다.


WRN을 비율을 정하는 방법

- 일관성 모델

  일관성 모델은 키-값 저장소를 설계할 때 고려해야할 또 하나의 중요한 요소다. 일관성 모델은 데이터 일관성의 수준을 결정하는데, 종류가 다양하다.

    - 강한 일관성 : 모든 읽기 연산은 가장 최근에 갱신된 결과를 반환.
    - 약한 일관성 : 읽기 연산은 가장 최근에 갱신된 결과를 반환하지 못할 수 있다.
    - 결과적 일관성 : 약한 일관성의 한 형태로, 갱신 결과가 결국에는 모든 사본에 반영되는 모델이다.
- 비 일관성 모델 해소 기법 : 데이터 비저닝

  데이터를 다중화하면 가용성은 높아지지만 사본 간 일관성이 깨질 가능성은 높아진다.

  값을 동시에 바꾸려고 하는 경우 : **백터 시계**

  → [서버, 버전] 의 순서쌍을 데이터에 매단것.