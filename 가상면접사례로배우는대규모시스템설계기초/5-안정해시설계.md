# 안정 해시 설계

### 해시 키 재배치 문제

n개의 캐시서버들에 부하를 균등하게 나누는 보편적인 방법은 해시함수를 사용하는 것이다.

`serverIndex = hash % n (서버의 개수)`

서버 풀의 크기가 고정되어있고 데이터 분포가 균등할때는 잘 동작하지만, 서버가 추가되거나 기존 서버가 삭제가 되면 문제가 발생하게 된다.

장애가 난 서버에 보관되어있는 대부분의 키가 재분배된다. (서버 인덱스가 변함으로) 대부분 캐시 클라이언트가 데이터가 없는 엉뚱한 서버에 접속하게 된다. → **대규모 캐시 미스 발생**

### 안정해시

해시 테이블 크기가 조정될때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술이다.

해시링의 형태로 해시서버를 배치함.

- 서버와 키를 균등분포 해시 함수를 사용해 해시 링에 배치한다
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버다.

**문제**

1. 서버가 추가되거나 삭제되는 상황을 감안하면 파티션의 크기를 균등하게 유지하는게 불가능하다는 것
    - 시계방향 서버가 삭제됨에 따라서, 파티션이 다른 파티션 대비 거의 두배로 커지게됨.
2. 키의 균등 분포 달성의 어려움
    - 대부분의 키가 하나의 서버에 쏠림 현상 발생 가능
    - ⇒ 해결책 : **가상 노드** 또는 복제 기법

**가상노드**

실제 노드 또는 서버를 가리키는 노드. 하나의 서버는 링 위에 여러개의 가상 노드를 가질 수 있다.

각 서버는 하나가 아닌 여러개의 파티션을 관리해야함.

가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해진다. 표준편차가 작아져서 데이터가 고르게 분포된다.

**이점**

1. 서버가 추가되거나 삭제될 때 재배치된느 키의 수가 최소화된다.
2. 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다.
3. 핫스팟 키의 문제를 줄인다. 특정 샤드에 대한 접근이 지나치게 빈번하면 서버 과부하 문제가 발생할 수 있다.

사용사례

- 아마존 다이나도 데이터베이스의 파티셔닝 관련 컴포넌트
- 아차피 카산드라 클러스터에서의 데이터 파티셔닝
- 디스코드 채팅어플리케이션
- 아카마이 CDN
- 매그레프 네트워크 부하 분산기